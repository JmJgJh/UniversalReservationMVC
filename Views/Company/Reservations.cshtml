@using UniversalReservationMVC.Models
@using UniversalReservationMVC.ViewModels
@model CompanyReservationsViewModel

@{
    ViewData["Title"] = "Rezerwacje";
    var company = ViewBag.Company as Company;
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2> Rezerwacje Twojej firmy</h2>
            <p class="text-muted">Zarzdzaj rezerwacjami dla wszystkich zasob贸w</p>
        </div>
        <div class="col-auto">
            <a href="@Url.Action("Dashboard")" class="btn btn-outline-secondary">Wr贸 do panelu</a>
        </div>
    </div>

    <!-- Filtry -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h6 class="mb-0"> Filtry i wyszukiwanie</h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Reservations" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Od daty</label>
                    <input type="date" name="from" class="form-control" value="@Model.From?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Do daty</label>
                    <input type="date" name="to" class="form-control" value="@Model.To?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="">-- Wszystkie statusy --</option>
                        <option value="Pending" @(Model.Status == "Pending" ? "selected" : "")>Oczekujca</option>
                        <option value="Confirmed" @(Model.Status == "Confirmed" ? "selected" : "")>Potwierdzona</option>
                        <option value="Cancelled" @(Model.Status == "Cancelled" ? "selected" : "")>Anulowana</option>
                        <option value="Completed" @(Model.Status == "Completed" ? "selected" : "")>Ukoczona</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100"> Filtruj</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Statystyki rezerwacji -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">@Model?.TotalCount</h5>
                    <p class="card-text text-muted small">Rezerwacje</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">@Model?.PendingCount</h5>
                    <p class="card-text text-muted small">Oczekujce</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">@Model?.ConfirmedCount</h5>
                    <p class="card-text text-muted small">Potwierdzone</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">@Model?.CancelledCount</h5>
                    <p class="card-text text-muted small">Anulowane</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela rezerwacji -->
    @if (Model?.Reservations?.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-hover shadow-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Go</th>
                        <th>Zas贸b</th>
                        <th>Data rozpoczcia</th>
                        <th>Data zakoczenia</th>
                        <th>Stanowiska</th>
                        <th>Status</th>
                        <th>Opacone</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var reservation in Model.Reservations)
                    {
                        <tr>
                            <td><code>@reservation.Id</code></td>
                            <td>
                                @if (!string.IsNullOrEmpty(reservation.GuestEmail))
                                {
                                    <span>@reservation.GuestEmail</span>
                                }
                                else if (reservation.User != null)
                                {
                                    <span>@reservation.User.FirstName @reservation.User.UserName</span>
                                }
                                else
                                {
                                    <span class="text-muted">Nieznany</span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">@reservation.Resource?.Name ?? "Zas贸b"</span>
                            </td>
                            <td>@reservation.StartTime.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>@reservation.EndTime.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>
                                @if (reservation.Seat != null)
                                {
                                    <span class="badge bg-info">@reservation.Seat.Label</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">brak miejsca</span>
                                }
                            </td>
                            <td>
                                @switch (reservation.Status)
                                {
                                    case ReservationStatus.Pending:
                                        <span class="badge bg-warning text-dark">Oczekujca</span>
                                        break;
                                    case ReservationStatus.Confirmed:
                                        <span class="badge bg-success">Potwierdzona</span>
                                        break;
                                    case ReservationStatus.Cancelled:
                                        <span class="badge bg-danger">Anulowana</span>
                                        break;
                                    case ReservationStatus.Completed:
                                        <span class="badge bg-secondary">Ukoczona</span>
                                        break;
                                    default:
                                        <span class="badge bg-light text-dark">@reservation.Status.ToString()</span>
                                        break;
                                }
                            </td>
                            <td>
                                @if (reservation.IsPaid)
                                {
                                    <span class="badge bg-success"><i class="fas fa-check-circle"></i> Tak</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary"><i class="fas fa-times-circle"></i> Nie</span>
                                }
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    @if (reservation.Status == ReservationStatus.Pending)
                                    {
                                        <form asp-action="ConfirmReservation" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@reservation.Id" />
                                            <button type="submit" class="btn btn-sm btn-success">Potwierd藕</button>
                                        </form>
                                    }

                                    @if (reservation.Status != ReservationStatus.Cancelled && reservation.Status != ReservationStatus.Completed)
                                    {
                                        <form asp-action="CancelReservation" method="post" class="d-inline" onsubmit="return confirm('Anulowa rezerwacj?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@reservation.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Anuluj</button>
                                        </form>
                                    }

                                    @if (reservation.Status == ReservationStatus.Cancelled || reservation.Status == ReservationStatus.Completed)
                                    {
                                        <span class="text-muted small">Brak akcji</span>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-5">
            <h5> Brak rezerwacji</h5>
            <p class="mb-0">Brak rezerwacji speniajcych wybrane kryteria.</p>
        </div>
    }

    @if (Model != null && Model.TotalCount > Model.PageSize)
    {
        var totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize);
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.Page <= 1 ? "disabled" : string.Empty)">
                    <a class="page-link" href="@Url.Action("Reservations", new { page = Model.Page - 1, pageSize = Model.PageSize, from = Model.From?.ToString("yyyy-MM-dd"), to = Model.To?.ToString("yyyy-MM-dd"), status = Model.Status })">&laquo;</a>
                </li>
                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : string.Empty)">
                        <a class="page-link" href="@Url.Action("Reservations", new { page = i, pageSize = Model.PageSize, from = Model.From?.ToString("yyyy-MM-dd"), to = Model.To?.ToString("yyyy-MM-dd"), status = Model.Status })">@i</a>
                    </li>
                }
                <li class="page-item @(Model.Page >= totalPages ? "disabled" : string.Empty)">
                    <a class="page-link" href="@Url.Action("Reservations", new { page = Model.Page + 1, pageSize = Model.PageSize, from = Model.From?.ToString("yyyy-MM-dd"), to = Model.To?.ToString("yyyy-MM-dd"), status = Model.Status })">&raquo;</a>
                </li>
            </ul>
        </nav>
    }

    <!-- Eksport i akcje -->
    <div class="row mt-4">
        <div class="col-md-6">
            <button type="button" class="btn btn-outline-secondary w-100"> Pobierz CSV</button>
        </div>
        <div class="col-md-6">
            <button type="button" class="btn btn-outline-secondary w-100"> Drukuj raport</button>
        </div>
    </div>
</div>
