@model UniversalReservationMVC.ViewModels.AnalyticsDashboardViewModel
@{
    ViewData["Title"] = "Analityka - " + ViewBag.CompanyName;
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-chart-line me-2"></i>Analityka biznesowa</h1>
            <p class="text-muted">Firma: <strong>@ViewBag.CompanyName</strong></p>
        </div>
        <div class="col-md-4 text-end">
            <a href="@Url.Action("Dashboard")" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Powrót do dashboardu
            </a>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="@Url.Action("Analytics")" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label"><i class="fas fa-calendar me-1"></i>Data początkowa</label>
                    <input type="date" name="startDate" class="form-control" 
                           value="@Model.StartDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-4">
                    <label class="form-label"><i class="fas fa-calendar me-1"></i>Data końcowa</label>
                    <input type="date" name="endDate" class="form-control" 
                           value="@Model.EndDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter me-1"></i>Zastosuj filtr
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Wszystkie rezerwacje</h6>
                            <h2 class="mb-0">@Model.TotalReservations</h2>
                        </div>
                        <i class="fas fa-calendar-check fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Potwierdzone</h6>
                            <h2 class="mb-0">@Model.ConfirmedReservations</h2>
                        </div>
                        <i class="fas fa-check-circle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Przychód (zapłacony)</h6>
                            <h2 class="mb-0">@Model.PaidRevenue.ToString("C", new System.Globalization.CultureInfo("pl-PL"))</h2>
                        </div>
                        <i class="fas fa-money-bill-wave fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Średnie obłożenie</h6>
                            <h2 class="mb-0">@Model.AverageOccupancy.ToString("F1")%</h2>
                        </div>
                        <i class="fas fa-percentage fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Obłożenie zasobów w czasie</h5>
                </div>
                <div class="card-body">
                    <canvas id="occupancyChart" height="80"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Rozkład statusów</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Przychody w czasie</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Najpopularniejsze zasoby</h5>
                </div>
                <div class="card-body">
                    <canvas id="popularResourcesChart" height="120"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Wzorzec rezerwacji (dzień tygodnia)</h5>
                </div>
                <div class="card-body">
                    <canvas id="dayOfWeekChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 4 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Wzorzec rezerwacji (godzina dnia)</h5>
                </div>
                <div class="card-body">
                    <canvas id="hourOfDayChart" height="60"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Resources Table -->
    @if (Model.PopularResources.Any())
    {
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top 10 zasobów</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nazwa zasobu</th>
                                        <th class="text-center">Liczba rezerwacji</th>
                                        <th class="text-end">Przychód</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < Model.PopularResources.Count; i++)
                                    {
                                        var resource = Model.PopularResources[i];
                                        <tr>
                                            <td>@(i + 1)</td>
                                            <td><strong>@resource.ResourceName</strong></td>
                                            <td class="text-center">
                                                <span class="badge bg-primary">@resource.BookingCount</span>
                                            </td>
                                            <td class="text-end">
                                                @resource.Revenue.ToString("C", new System.Globalization.CultureInfo("pl-PL"))
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        // Chart.js default configuration
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        
        // Occupancy Chart
        const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
        new Chart(occupancyCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OccupancyData.Labels)),
                datasets: [{
                    label: 'Obłożenie (%)',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OccupancyData.Values)),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Obłożenie: ' + context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });

        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RevenueData.Labels)),
                datasets: [
                    {
                        label: 'Przychód całkowity',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RevenueData.TotalRevenue)),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    },
                    {
                        label: 'Przychód zapłacony',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RevenueData.PaidRevenue)),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(0) + ' PLN';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' PLN';
                            }
                        }
                    }
                }
            }
        });

        // Status Distribution Chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Potwierdzone', 'Oczekujące', 'Anulowane', 'Ukończone'],
                datasets: [{
                    data: [
                        @Model.StatusDistribution.Confirmed,
                        @Model.StatusDistribution.Pending,
                        @Model.StatusDistribution.Cancelled,
                        @Model.StatusDistribution.Completed
                    ],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(153, 102, 255, 0.8)'
                    ],
                    borderColor: [
                        'rgb(54, 162, 235)',
                        'rgb(255, 206, 86)',
                        'rgb(255, 99, 132)',
                        'rgb(153, 102, 255)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Popular Resources Chart
        const popularResourcesCtx = document.getElementById('popularResourcesChart').getContext('2d');
        new Chart(popularResourcesCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PopularResources.Select(r => r.ResourceName).ToList())),
                datasets: [{
                    label: 'Liczba rezerwacji',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PopularResources.Select(r => r.BookingCount).ToList())),
                    backgroundColor: 'rgba(255, 159, 64, 0.5)',
                    borderColor: 'rgb(255, 159, 64)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Day of Week Chart
        const dayOfWeekCtx = document.getElementById('dayOfWeekChart').getContext('2d');
        new Chart(dayOfWeekCtx, {
            type: 'bar',
            data: {
                labels: ['Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota', 'Niedziela'],
                datasets: [{
                    label: 'Liczba rezerwacji',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BookingPatterns.ByDayOfWeek)),
                    backgroundColor: 'rgba(153, 102, 255, 0.5)',
                    borderColor: 'rgb(153, 102, 255)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Hour of Day Chart
        const hourOfDayCtx = document.getElementById('hourOfDayChart').getContext('2d');
        new Chart(hourOfDayCtx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + ':00'),
                datasets: [{
                    label: 'Liczba rezerwacji',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BookingPatterns.ByHourOfDay)),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
}
